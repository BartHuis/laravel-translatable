machine:
  php:
    version: 7.0.4

dependencies:
  override:
    - composer self-update
    - mysql -e 'create database translatable_test;'
    - echo "CREATE USER 'homestead'@'localhost' IDENTIFIED BY 'secret'; \n GRANT ALL PRIVILEGES ON * . * TO 'homestead'@'localhost'; \nFLUSH PRIVILEGES; \n" | mysql -u root
    - alias xdebug-off="mv /opt/circleci/php/$(phpenv global)/etc/conf.d/xdebug.ini /opt/circleci/php/$(phpenv global)/etc/conf.d/xdebug.ini_disabled"
    - alias xdebug-on="mv /opt/circleci/php/$(phpenv global)/etc/conf.d/xdebug.ini_disabled /opt/circleci/php/$(phpenv global)/etc/conf.d/xdebug.ini"

test:
  override:
    - xdebug-off
    # install dependencies using laravel 5.3
    - composer require illuminate/support:"5.3.*" --prefer-source --no-interaction
    - xdebug-on
    - phpunit
    - xdebug-off
    # reinstall vendors with laravel 5.2
    - rm -rf vendor composer.lock
    - git checkout -- composer.json
    - composer require illuminate/support:"5.2.*" --prefer-source --no-interaction
    - xdebug-on
    - phpunit --coverage-clover=coverage.clover
    - wget https://scrutinizer-ci.com/ocular.phar
    - php ocular.phar code-coverage:upload --format=php-clover coverage.clover
